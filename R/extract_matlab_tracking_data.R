# Author: Aaron Munro Allen
# Date: 2021-11-19
# Description:
#   Functions to extract all data generated by the Caltech FlyTracker and JAABA
#   packages written in Matlab. It may not matter, but this file assumes that "id_correction"
#   has been run from https://github.com/aaron-allen/goodwin-lab-tracking repo.



extract_all_data <- function(tracking_dir_path) {
    library(tidyverse)
    library(R.matlab)
    
    # source("extract_track_data.R")
    # source("extract_feat_data.R")
    # source("extract_jaaba_data.R")
    
    if ( .Platform$OS.type == "windows" ) {
        tracking_dir_path <- tracking_dir_path %>% stringr::str_replace_all(pattern = "\\\\", "/")    
    }
    if ( !stringr::str_detect(tracking_dir_path, "/$") ) {
        tracking_dir_path <- paste0(tracking_dir_path, "/")
    }
    
    vid_name <- tracking_dir_path %>% stringr::str_extract(pattern = "[^/]*/$") %>% stringr::str_remove(pattern = "/")
    cat(paste0("Video name is :      ", vid_name,"\n"))
    
    cat(paste0("    Now extracting track data\n"))
    my_track_data <- extract_track_data(paste0(tracking_dir_path, vid_name, "/", vid_name, "-track.mat"))
    cat(paste0("    Now extracting feat data\n"))
    my_feat_data <- extract_feat_data(paste0(tracking_dir_path, vid_name, "/", vid_name, "-feat.mat"))
    cat(paste0("    Now extracting jaaba data\n"))
    my_jaaba_data <- extract_jaaba_data(paste0(tracking_dir_path, vid_name, "/", vid_name, "_JAABA/"))

    cat(paste0("    Now merging all data\n"))
    my_data <-dplyr::bind_rows(my_track_data,
                               dplyr::bind_rows(my_feat_data,my_jaaba_data)) %>%
        dplyr::mutate(Video_name = vid_name,
               Arena = dplyr::if_else((Fly_Id %% 2) == 0, Fly_Id/2, ceiling(Fly_Id/2))
               ) %>% 
        dplyr::group_by(Video_name, Fly_Id, Frame) 
    return(my_data)
}







extract_track_data <- function(file_path) {
    # Author: Aaron Munro Allen
    # Date: 2021-11-15
    # Description:
    #   Function to extract data from the "track.mat" file generated by the Caltech FlyTracker
    #   package written in Matlab. It may not matter, but this file assumes that "id_correction"
    #   has been run from https://github.com/aaron-allen/goodwin-lab-tracking repo.
    library(tidyverse)
    library(R.matlab)
    
    ufmf_track <- R.matlab::readMat(file_path)
    
    # names
    for (i in seq_along(ufmf_track[["trk"]][[1]])) {
        if (i == 1) {
            track_names <- list()
        }
        track_names[[i]] <- ufmf_track[["trk"]][[1]][[i]][[1]][1,1]
    }
    track_names <- unlist(track_names) %>% stringr::str_replace(" ", "_")
    track_units <- c("px", "px", "rad", "px", "px", "px", "px", "au", "px", 
                     "px", "px", "px", "px", "rad", "px", "rad", "px", "px", 
                     "px", "px", "px", "px", "px", "px", "px", "px", "px", 
                     "px", "px", "rad", "rad", "rad", "rad", "rad", "rad")
    
    # flies.in.chamber
    for (i in seq_along(ufmf_track[["trk"]][[3]])) {
        if (i == 1) {
            fly_ids <- list()
        }
        fly_ids[[i]] <- tibble::tibble(Arena = rep(i,length(ufmf_track[["trk"]][[3]][[i]][[1]][1,])),
                                       Fly_Id = ufmf_track[["trk"]][[3]][[i]][[1]][1,])
    }
    fly_ids <- dplyr::bind_rows(fly_ids)
    
    # data
    for (i in seq_along(track_names)) {
        if (i == 1) {
            track_data <- list()
        }
        for (ii in seq_along(fly_ids$Fly_Id)) {
            if (ii == 1) {
                track_data_feature <- list()
            }
            track_data_feature[[ii]] <- tibble::tibble(Frame = 1:dim(ufmf_track[["trk"]][[2]])[2],
                                                       Fly_Id = fly_ids$Fly_Id[[ii]],
                                                       Feature = track_names[[i]],
                                                       Units = track_units[[i]],
                                                       Value = ufmf_track[["trk"]][[2]][ii,,i],
                                                       Data_Source = "track.mat"
            )
        }
        track_data[[i]] <- dplyr::bind_rows(track_data_feature)
    }
    track_data <- dplyr::bind_rows(track_data)
    
    # flags
    
    # ...
    
    # pull together
    track_data <- dplyr::right_join(fly_ids,track_data, by = "Fly_Id")
    
    return(track_data)
}

extract_feat_data <- function(file_path) {
    # Author: Aaron Munro Allen
    # Date: 2021-11-15
    # Description:
    #   Function to extract data from the "feat.mat" file generated by the Caltech FlyTracker
    #   package written in Matlab. It may not matter, but this file assumes that "id_correction"
    #   has been run from https://github.com/aaron-allen/goodwin-lab-tracking repo.
    library(tidyverse)
    library(R.matlab)
    
    ufmf_feat <- R.matlab::readMat(file_path)
    
    # names
    feat_names <- unlist(ufmf_feat[["feat"]][[1]])    
    ufmf_feat[["feat"]][[2]][[8]] <- ufmf_feat[["feat"]][[2]][[1]]
    ufmf_feat[["feat"]][[2]][[8]][[1]][1,1] <- "au"
    feat_units <- unlist(ufmf_feat[["feat"]][[2]])
    
    # data
    for (i in 1:dim(ufmf_feat[["feat"]][[3]])[3]) {
        if (i == 1) {
            feat_data <- list()
        }
        for (ii in 1:dim(ufmf_feat[["feat"]][[3]])[1]) {
            if (ii == 1) {
                feat_data_feature <- list()
            }
            feat_data_feature[[ii]] <- tibble::tibble(Frame = 1:dim(ufmf_feat[["feat"]][[3]])[2],
                                                      Fly_Id = ii,
                                                      Feature = feat_names[[i]],
                                                      Units = feat_units[[i]],
                                                      Value = ufmf_feat[["feat"]][[3]][ii,,i],
                                                      Data_Source = "feat.mat"
            )
        }
        feat_data[[i]] <- dplyr::bind_rows(feat_data_feature)
    }
    feat_data <- dplyr::bind_rows(feat_data)
    
    return(feat_data)
}

extract_jaaba_data <- function(dir_path,raw = FALSE) {
    # Author: Aaron Munro Allen
    # Date: 2021-11-15
    # Description:
    #   Function to extract data from the JAABA scores files generated by the JAABA package written in Matlab.
    #   This function assumes that "id_correction" has been run from https://github.com/aaron-allen/goodwin-lab-tracking.
    #   The files are of the form "scores_<behaviour>_id_corrected.mat".
    library(tidyverse)
    library(R.matlab)
    
    i <- dplyr::if_else(raw, 1, 4)
    jaaba_scores_files <- list.files(dir_path) %>% stringr::str_subset("scores_") %>% stringr::str_subset("_id_corrected.mat")
    for (ii in seq_along(jaaba_scores_files)) {
        if (ii == 1) {
            jaaba_scores <- list()
        }
        jaaba_scores_file <- R.matlab::readMat(paste0(dir_path,jaaba_scores_files[[ii]]))
        jaaba_behaviour <- jaaba_scores_files[[ii]] %>% stringr::str_remove("scores_") %>% stringr::str_remove("_id_corrected.mat")
        for (iii in 1:length(jaaba_scores_file[["allScores"]][[1]])) {
            if (iii == 1) {
                jaaba_scores_ind <- list()
            }
            jaaba_scores_ind[[iii]] <- tibble::tibble(Frame = 1:length(jaaba_scores_file[["allScores"]][[i]][[iii]][[1]][1,]),
                                                      Fly_Id = iii,
                                                      Feature = jaaba_behaviour,
                                                      Units = dplyr::if_else(raw, "raw", "processed"),
                                                      Value = jaaba_scores_file[["allScores"]][[i]][[iii]][[1]][1,],
                                                      Data_Source = "jaaba"
            )
        }
        jaaba_scores[[ii]] <- dplyr::bind_rows(jaaba_scores_ind)
    }
    jaaba_scores <- dplyr::bind_rows(jaaba_scores)
    return(jaaba_scores)
}









